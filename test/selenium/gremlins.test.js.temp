/**
 * Copyright (c) 2013-2016 Memba Sarl. All rights reserved.
 * Sources at https://github.com/Memba
 */

/* jshint node: true, mocha: true, expr: true */
/* globals browser: false */

'use strict';

var expect = require('chai').expect;
var util = require('util');

var config = require('../../webapp/config');
var url = require('../../webapp/lib/url');

var webapp = {
    home: url.join(config.get('uris:webapp:root'), config.get('uris:webapp:home'))
};

var WAIT = 2000;
var SCREEN = {
    HEIGHT: 800,
    WIDTH: 1280
};

/**
 * Enhance browser with our Ex functions
 */
require('./selenium');

/**
 * Now testing
 */
describe('Monkey testing with gremlins', function () {

    var tabId;

    before(function () {
        if (browser.desiredCapabilities.browserName === 'firefox') {
            // This prevents `No such content frame; perhaps the listener was not registered?`
            browser.pause(200);
        }
        browser.url(webapp.home);
        tabId = browser.getCurrentTabId();
        // Note: it won't work in PhantomJS without setting the window size
        browser.windowHandleSize({ height: SCREEN.HEIGHT, width: SCREEN.WIDTH });
        // Now load our gremlins
        browser.timeoutsAsyncScript(5000);
        browser.executeAsync(function (done) {
        // browser.execute(function () {
            var SRC = 'https://raw.githubusercontent.com/marmelab/gremlins.js/master/gremlins.min.js';
            var head = document.getElementsByTagName('head')[0];
            var scripts = head.getElementsByTagName('script');
            var found = false;
            for (var i = 0; i < scripts.length; i++) {
                if (scripts[i].src === SRC) {
                    found = true;
                    break;
                }
            }
            if (!found) {
                var script = document.createElement('script');
                script.type = 'text/javascript';
                // @see https://www.nczonline.net/blog/2009/06/23/loading-javascript-without-blocking/
                if (script.readyState){  //IE
                    script.onreadystatechange = function(){
                        if (script.readyState == "loaded" ||
                            script.readyState == "complete"){
                            script.onreadystatechange = null;
                            done();
                        }
                    };
                } else {  //Others
                    script.onload = function(){
                        done();
                    };
                }
                script.src = SRC;
                head.appendChild(script);
            }
        });
    });

    describe('When testing', function () {

        // Retry all tests in this suite up to 3 times
        this.retries(3);

        beforeEach(function () {
            // browser.switchTab ensures we are running all tests on the same tab
            // especially as we have experienced extensions like Skype that open a welcome page in a new tab
            browser.switchTab(tabId);
            browser.logger.info(browser.getUrl());
        });

        it('it should not raise any error', function () {
            // browser.timeoutsAsyncScript(5000);
            var result = browser.execute(function () {
                return window.gremlins !== undefined;
                // var global = (new Function("return this")());
                // global.gremlins.createHorde().unleash();
                /*
                var head = document.getElementsByTagName('head')[0];
                var script = document.createElement('script');
                script.type = 'text/javascript';
                script[(window.opera ? 'innerHTML' : 'text')] = 'throw new Error("Oops");';
                // script[(window.opera ? 'innerHTML' : 'text')] = 'gremlins.createHorde().unleash();';
                head.appendChild(script);
                */
                // setTimeout(done, 5000);
            });
            expect(result.value).to.be.true;
        });

    });

});
